import{Renderer,Program,Mesh,Vec2,Texture,Flowmap,Plane}from"./distortion-img-depend.js";!function(){"use strict";const e=document.querySelector(".th-image-distortion");if(!e)return;const n=e.getAttribute("data-background"),t=new Renderer,i=t.gl;e.appendChild(i.canvas);const o=new Vec2(.5),r=new Vec2(.5),a=new Vec2;let c=1;function s(){const n=e.getBoundingClientRect();c=n.width/n.height,i.canvas.width=n.width,i.canvas.height=n.height,t.setSize(n.width,n.height)}window.addEventListener("resize",s,!1),s();const u=new Flowmap(i,{falloff:.3,dissipation:.95,size:1e3}),g=new Plane(i),l=new Texture(i),m=new Image;m.crossOrigin="anonymous",m.onload=()=>{l.image=m,l.minFilter=i.LINEAR,l.magFilter=i.LINEAR,l.wrapS=i.CLAMP_TO_EDGE,l.wrapT=i.CLAMP_TO_EDGE},m.src=n;const v=new Program(i,{vertex:"\n        attribute vec2 uv;\n        attribute vec2 position;\n        varying vec2 vUv;\n\n        void main() {\n            vUv = uv;\n            gl_Position = vec4(position, 0.0, .45);\n        }\n    ",fragment:"\n        precision highp float;\n        uniform sampler2D tImage;\n        uniform sampler2D tFlow;\n        varying vec2 vUv;\n\n        void main() {\n            vec3 flow = texture2D(tFlow, vUv).rgb;\n            vec2 uv = vUv;\n            uv += (flow.rg * flow.b * 50.0);\n            vec3 tex = texture2D(tImage, uv).rgb;\n            gl_FragColor.rgb = tex;\n            gl_FragColor.a = 1.0;\n        }\n    ",uniforms:{tImage:{value:l},tFlow:u.uniform}}),d=new Mesh(i,{geometry:g,program:v});function w(n){const t=e.getBoundingClientRect(),i=(n.clientX-t.left)/t.width,r=1-(n.clientY-t.top)/t.height;o.set(i,r)}e.addEventListener("mousemove",w,!1),e.addEventListener("touchmove",(e=>{e.touches.length>0&&w(e.touches[0])}),!1);const h=new Vec2;requestAnimationFrame((function e(){h.copy(o).sub(r).multiply(.04),a.add(h).multiply(.8),r.add(a),u.mouse.copy(r),u.velocity.copy(a),u.aspect=c,u.update(),t.render({scene:d}),requestAnimationFrame(e)}))}(jQuery);